### 解析器、源码、内部类

~~~python
实质： 依据Content-Type将请求体(request.body) 中的数据解析到 request.data
~~~



#### Django （有局限）

满足以下两个条件，request.POST中才有值。Django只支持 固定请求头、固定数据格式 的请求体的解析。

~~~python
1. 请求头要求
Content-Type: application/x-www-form-urlencoded
PS: 如果请求头中的 Content-Type: application/x-www-form-urlencoded，request.POST中才有值（才会去request.body中解析数据）。

2. 数据格式要求：
name=alex&age=18&gender=男

如：
a. form表单提交时，就是按照上面的 两个条件 进行请求的
<form method...>
	input...
</form>

b. ajax提交，默认为以上 两个条件 进行请求
$.ajax({
    url:...
    type:POST,
    data:{name:alex,age=18} # 内部转化 name=alex&age=18&gender=男
})
~~~

错误请求案例

~~~python
情况一：# body有值；POST无
$.ajax({
    url:...
    type:POST,
    headers:{'Content-Type':"application/json"}  # 错误请求头
    data:{name:alex,age=18} # 内部转化 name=alex&age=18&gender=男
})


情况二：# body有值；POST无
$.ajax({
    url:...
    type:POST,
    headers:{'Content-Type':"application/json"}  # 错误请求头
    data:JSON.stringfy({name:alex,age=18}) # {name:alex,age:18...}  # 错误数据类型
})

# 当这样传送数据时 JSON.stringfy({"name":"alex","age"=18}) ，可以通过以下方式获取
reInfo = json.loads(request.body)   #  {name:alex,age:18...}
name = reInfo['name']
~~~



#### Django restful framework (建议使用全局配置)

~~~python
# 局部使用

from rest_framework.parsers import JSONParser, FormParser

class ParserView(APIView):

    """
    JSONParser:表示只能解析content-type:application/json头
    FormParser:表示只能解析content-type:application/x-www-form-urlencoded头
    """	

    parser_classes = [JSONParser]
    # parser_classes = [JSONParser,FormParser,]
    
    def post(self, request, *args, **kwargs):
        """
        允许用户发送JSON格式数据
            a. content-type: application/json
            b. {'name':'alex',age:18}
        """
        """
        1. 获取用户请求头
        2. 获取用户请求体
        3. 根据用户请求头 和 parser_classes = [JSONParser,FormParser,] 中支持的请求头进行比较
        4. JSONParser对象去请求体解析数据
        5. request.data
        """
        
        # 获取数据
        # 只有使用请求头中的数据时，才会去解析
        print(request.data)  # {'name':'alex',age:18}

        return HttpResponse('ParserView')
    
# 全局使用
REST_FRAMEWORK = {
    "DEFAULT_PARSER_CLASSES": ['rest_framework.parsers.JSONParser','rest_framework.parsers.FormParser']
}

class ParserView(APIView):
    def post(self, request, *args, **kwargs):
        print(request.data)  # {'name':'alex',age:18}
        return HttpResponse('ParserView')
    
# 注意: 
    drf 默认帮我们配置了 3 个解析器
    [
        rest_framework.parsers.JSONParser,
        rest_framework.parsers.FormParser,
        rest_framework.parsers.MultiPartParser
    ]
~~~

#### 源码、本质

~~~python
1. request封装 
self.dispatch -> initialize_request() -> get_parsers()  # 此时 request 中已有所有的解析器对象


2. 解析器 数据解析
Request -> data -> _load_data_and_files() -> _parse()、select_parser(self, self.parsers)、parser.parse()


# 用户提交的请求头 Content_Type 的值
media_type = self.content_type

# parsers: parser_classes=[JSONParser, FormParser, ]
# self: 请求对象, 其中含有 self.content_type
# 作用： 返回可以解析用户请求头数据的解析类
parser = self.negotiator.select_parser(self, self.parsers)

# 数据解析
parser.parse()
~~~

~~~python
本质: 基于 请求头中的 Content_Type 做操作
~~~





#### 内部类

~~~python
# MultiPartParser (drf默认帮我们配置了该解析器)
media_type = 'multipart/form-data'
表单上传文件的，通过 request.FILES 获取


# FileUploadParser
media_type = '*/*'

~~~

###### 友情链接

[老师笔记](https://www.cnblogs.com/wupeiqi/articles/7805382.html)