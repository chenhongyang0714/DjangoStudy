### 版本控制、源码流程、内部类

#### 当在 URL 中通过 GET 传递版本时（自定义）

###### 把获取版本号的代码写到视图中

~~~python
# http://127.0.0.1:8000/api/users/?version=v2

class UsersView(APIView):

    def get(self,request,*args,**kwargs):
        # 方法一
        version = request._request.GET.get('version')
        print(version)
        # 方法二
        version = request.query_params.get('version')
        print(version)
        return HttpResponse('用户列表')

~~~

###### 把获取版本号的代码写到父类

~~~python
# http://127.0.0.1:8000/api/users/?version=v2

class ParamVersion(object):
    def determine_version(self, request, *args, **kwargs):
        version = request.query_params.get('version')
        return version

    class UsersView(APIView):

        versioning_class = ParamVersion
        
        def get(self,request,*args,**kwargs):
            
            print(request.version)
            return HttpResponse('用户列表')
~~~

#### 当在 URL 中通过 GET 传递版本时（继承drf内部类）

###### 全局使用

~~~python
# http://127.0.0.1:8000/api/users/?version=v2

from rest_framework.versioning import QueryParameterVersioning

class UsersView(APIView):

    versioning_class = QueryParameterVersioning
    
    def get(self,request,*args,**kwargs):
        print(version)
        return HttpResponse('用户列表')

REST_FRAMEWORK = {
    # 默认版本
    "DEFAULT_VERSION":'v1',
    # 允许访问的版本
    "ALLOWED_VERSIONS":['v1','v2'],
    # URL中指示 版本的 key
    "VERSION_PARAM":'version',
}
~~~

#### 当在 URL 中通过路径传递版本时  (推荐使用)

~~~python
# http://127.0.0.1:8000/v1/api/users

# url 
urlpatterns = [
    url(r'^(?P<version>[v1|v2]+)/users/$', views.UsersView.as_view()),
]

# settings
REST_FRAMEWORK = {
    "DEFAULT_VERSIONING_CLASS":"rest_framework.versioning.URLPathVersioning",
    # 默认版本
    "DEFAULT_VERSION":'v1',
    # 允许访问的版本
    "ALLOWED_VERSIONS":['v1','v2'],
    # URL中指示 版本的 key
    "VERSION_PARAM":'version',
}

# views
class UsersView(APIView):

    def get(self,request,*args,**kwargs):
        print(request.version)
        return HttpResponse('用户列表')
~~~



#### 源码流程

~~~python
self.dispatch -> initial() -> determine_version() -> request.version, request.versioning_scheme
~~~



#### 反向生成 URL

~~~python
class UsersView(APIView):

    def get(self, request, *args, **kwargs):
        
        # 获取版本
        print(request.version)
        
        
        # 获取处理版本的对象
        print(request.versioning_scheme)

        # 反向生成URL（rest framework）
        u1 = request.versioning_scheme.reverse(viewname='uuu', request=request)
        print(u1)

        # 反向生成URL
        u2 = reverse(viewname='uuu', kwargs={'version': 2})
        print(u2)

        return HttpResponse('...')
~~~



#### 内部类

~~~python
# AcceptHeaderVersioning
基于请求头实现
    GET /something/ HTTP/1.1
    Host: example.com
    Accept: application/json; version=1.0

        
# URLPathVersioning  (常用)
在 路由上 配置
urlpatterns = [
        url(r'^(?P<version>[v1|v2]+)/users/$', users_list, name='users-list'),
    ]


# HostNameVersioning
基于子域名实现
    GET /something/ HTTP/1.1
    Host: v1.example.com
    Accept: application/json

        
# QueryParameterVersioning
在 URL 上传参
GET /something/?version=0.1 HTTP/1.1


# NamespaceVersioning
基于 namespace 实现
urlpatterns = [
    url(r'^v1/', include('users.urls', namespace='v1')),
    url(r'^v2/', include('users.urls', namespace='v2'))
]
~~~





